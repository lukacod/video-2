<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Lucas Koh Golf â€” Swing Recorder Pro</title>
  <style>
:root{
  --bg:#05060a; --accent:#fff; --muted:#9aa4ad; --primary:#2f80ed; --red:#ff3b30; --glass:rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--accent);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial}
#app{height:100vh;display:flex;flex-direction:column}
.topbar{height:64px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:linear-gradient(180deg, rgba(0,0,0,0.28), transparent);z-index:20}
.icon-btn{width:44px;height:44px;border-radius:10px;border:none;background:var(--glass);color:var(--accent);font-size:20px;cursor:pointer;opacity:1;transition:opacity 0.2s;}
.icon-btn:active{transform:scale(0.95)}
.icon-btn:disabled{opacity:0.5;cursor:not-allowed;}
.title{text-align:center}
.app-name{font-weight:700;font-size:15px}
.subtitle{font-size:11px;color:var(--muted)}

.camera-area{flex:1;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden}
video#preview{width:100%;height:100%;object-fit:cover;background:#000;}

/* Onform App-like timer position */
.top-timer-wrap{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:10;display:none;align-items:center;gap:6px;}
.top-timer-wrap.active{display:flex;}
.top-timer-dot{width:10px;height:10px;border-radius:50%;background:var(--red);animation:pulse 1s infinite alternate;}
.top-timer{background:rgba(0,0,0,0.65);padding:6px 10px;border-radius:6px;font-variant-numeric:tabular-nums;font-weight:700;color:var(--accent);font-size:14px;letter-spacing:0.5px}

@keyframes pulse {
  from { opacity: 1; }
  to { opacity: 0.5; }
}


.controls{position:absolute;left:0;right:0;bottom:28px;display:flex;justify-content:center;pointer-events:none}
.record-wrap{pointer-events:auto;display:flex;flex-direction:column;align-items:center}
.record{width:88px;height:88px;border-radius:50%;border:6px solid rgba(255,255,255,0.15);background:transparent;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 30px rgba(0,0,0,0.6);transition:transform .12s, border-color .2s;cursor:pointer}
.record:active{transform:scale(0.95)}
.record.recording{border-color:var(--red);}
.record.recording .inner{border-radius:12px;width:30px;height:30px;background:var(--red);box-shadow:0 0 0 10px rgba(255,59,48,0.15)}
.record:disabled{opacity:0.6;cursor:not-allowed;}


.playback{position:fixed;inset:6% 4%;background:linear-gradient(180deg, rgba(3,7,18,0.98), rgba(3,7,18,0.99));border-radius:14px;padding:12px;z-index:50;display:flex;flex-direction:column;gap:12px;box-shadow:0 20px 60px rgba(0,0,0,0.7)}
.playback-header{display:flex;justify-content:space-between;align-items:center}
.playback-title{font-weight:700}
.playback-actions{display:flex;gap:8px}
.btn{background:transparent;border:0;color:var(--accent);padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
.btn:active{transform:scale(0.95)}
.btn.ghost{background:var(--glass)}
.btn.primary{background:var(--primary);color:#fff}
.btn.speed{background:var(--glass);min-width:90px;font-weight:700;}
.btn.speed.active{background:var(--primary);color:#fff}
.playback-body{position:relative}
.playback video{width:100%;height:60vh;background:#000;border-radius:8px;object-fit:contain}
.speed-overlay{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.75);padding:8px 14px;border-radius:8px;font-weight:700;font-size:16px;color:var(--accent)}
.hidden{display:none !important}
.playback-controls{display:flex;gap:12px;justify-content:center;padding-top:4px;}
.note{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}

.message{position:fixed;left:50%;transform:translateX(-50%);bottom:120px;background:rgba(0,0,0,0.8);padding:10px 16px;border-radius:10px;color:var(--accent);z-index:60;font-size:14px}

.fps-select{background:var(--glass);border-radius:8px;padding:8px 12px;color:var(--accent);border:0;font-size:14px;font-weight:600;cursor:pointer;-webkit-appearance:none;appearance:none;padding-right:30px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;background-size:16px;}
.fps-select option:disabled{color:var(--muted)}
  </style>
</head>
<body>
  <div id="app" class="onform-like">
    <header class="topbar">
      <button id="galleryBtn" class="icon-btn" title="ì‚¬ì§„ì²©ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°" aria-label="gallery">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M21 19V5a2 2 0 0 0-2-2H5C3.895 3 3 3.895 3 5v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 8h.01M16 8h.01M21 19V5a2 2 0 0 0-2-2H5c-1.105 0-2 .895-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM8 12.5l2 2 4-4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="title">
        <div class="app-name">Lucas Koh Golf</div>
        <div class="subtitle">Swing Recorder</div>
      </div>
      <div class="right-controls">
        <label class="fps-wrap" title="ë…¹í™” FPS ì„ íƒ">
          <select id="fpsSelect" class="fps-select" aria-label="ë…¹í™” FPS">
            <option value="30">30fps</option>
            <!-- 240fps option will be enabled if supported -->
            <option value="240">240fps</option>
          </select>
        </label>
      </div>
    </header>

    <main class="camera-area">
      <video id="preview" playsinline autoplay muted></video>

      <!-- Onform-style Timer -->
      <div id="topTimerWrap" class="top-timer-wrap">
        <span class="top-timer-dot"></span>
        <div id="topTimer" class="top-timer">00:00.00</div>
      </div>
      
      <div class="controls">
        <div class="record-wrap">
          <button id="recordBtn" class="record" aria-pressed="false" title="ë…¹í™” ì‹œì‘/ì¤‘ì§€">
            <span class="ring"></span>
            <span class="inner"></span>
          </button>
        </div>
      </div>
    </main>

    <section id="playbackArea" class="playback hidden" aria-hidden="true">
      <div class="playback-header">
        <div class="playback-title">ì˜ìƒ ì¬ìƒ</div>
        <div class="playback-actions">
          <button id="saveBtn" class="btn primary">ì €ì¥</button>
          <button id="closePlayback" class="btn ghost">ë‹«ê¸°</button>
        </div>
      </div>
      <div class="playback-body">
        <!-- controls ì†ì„± ì œê±°: ì¬ìƒ ì†ë„ ì œì–´ë¥¼ ì»¤ìŠ¤í…€ ë²„íŠ¼ìœ¼ë¡œ ê°•ì œí•¨ -->
        <video id="playback" playsinline></video> 
        <div id="speedOverlay" class="speed-overlay">30fps (1x)</div>
      </div>
      <div class="playback-controls">
        <button id="speed30" class="btn speed active" data-speed="30">30fps (1x)</button>
        <button id="speed240" class="btn speed" data-speed="240">240fps (1/8x)</button>
      </div>
      <p class="note">ì €ì¥ í›„ ê³µìœ  ì‹œíŠ¸ì—ì„œ 'ë¹„ë””ì˜¤ ì €ì¥'ì„ ì„ íƒí•´ ì‚¬ì§„ ì•±ì— ì €ì¥í•˜ì„¸ìš”.</p>
    </section>

    <input id="fileInput" type="file" accept="video/*" style="display:none">

    <div id="message" class="message hidden" role="status"></div>
  </div>

<script>
/* Golf Swing Recorder - Professional Version
 * Fixed: Recording button, 240fps detection, playback speeds (30fps/240fps), beep sound, timer
 * GitHub Pages Ready: All code contained in one HTML file.
 */
document.addEventListener('DOMContentLoaded', () => {
  const preview = document.getElementById('preview');
  const recordBtn = document.getElementById('recordBtn');
  const fpsSelect = document.getElementById('fpsSelect');
  const fileInput = document.getElementById('fileInput');
  const galleryBtn = document.getElementById('galleryBtn');
  const playbackArea = document.getElementById('playbackArea');
  const playback = document.getElementById('playback');
  const saveBtn = document.getElementById('saveBtn');
  const closePlayback = document.getElementById('closePlayback');
  const speed30 = document.getElementById('speed30');
  const speed240 = document.getElementById('speed240');
  const speedOverlay = document.getElementById('speedOverlay');
  const message = document.getElementById('message');
  const topTimer = document.getElementById('topTimer'); // Onform-like timer element
  const topTimerWrap = document.getElementById('topTimerWrap'); // Timer container

  let mediaStream = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let isRecording = false;
  let timerInterval = null;
  let timerT0 = 0;
  let audioContext = null;

  const supportsGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
  const supportsMediaRecorder = typeof MediaRecorder !== 'undefined';
  let is240fpsSupported = false; // Global flag for 240fps support

  function showMessage(txt, ms=2000) {
    message.textContent = txt;
    message.classList.remove('hidden');
    if (message._timeout) clearTimeout(message._timeout);
    message._timeout = setTimeout(() => message.classList.add('hidden'), ms);
  }

  function chooseMimeType() {
    // Priority: video/mp4 for better compatibility and playback on iOS/macOS
    const candidates = [
      'video/mp4;codecs=avc1',
      'video/mp4',
      'video/webm;codecs=vp9',
      'video/webm',
    ];
    for (const type of candidates) {
      if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(type)) {
        return type;
      }
    }
    return '';
  }

  // ìš”ì²­í•˜ì‹  'ë…¹í™” ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œì— ì‹¤í–‰ì´ ë˜ë©´ ì†Œë¦¬ê°€ ë‚˜ê²Œ' í•˜ëŠ” ê¸°ëŠ¥
  function playBeep() {
    try {
      if (!audioContext) {
        // AudioContextëŠ” ë…¹í™” ì „ ë¯¸ë¦¬ ì´ˆê¸°í™”ë˜ì–´ì•¼ iOS ë“±ì—ì„œ ì˜ ì‘ë™í•©ë‹ˆë‹¤.
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 880; 
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
      
      console.log('Beep played successfully');
    } catch (e) {
      console.warn('Beep failed:', e);
    }
  }

  async function startPreview() {
    if (!supportsGetUserMedia) {
      showMessage('ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.', 5000);
      return false;
    }

    const selectedFps = Number(fpsSelect.value);
    
    // Stop existing tracks first
    if (mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
    }
    
    let streamAttemptSuccess = false;

    // 1. Try environment camera (ideal for golf swing) with high constraints.
    let constraints = {
      audio: true,
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1920 },
        height: { ideal: 1080 },
        // Use ideal/max for 240fps, or exact for 30fps
        frameRate: selectedFps === 240 && is240fpsSupported
          ? { ideal: 240, max: 240 }
          : { exact: 30 }
      }
    };

    try {
      mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
      streamAttemptSuccess = true;
    } catch (err) {
      console.error('Attempt 1 (Environment/High-res) failed:', err.message);
      
      // 2. Fallback: Try ANY camera (user or environment) with minimum constraints.
      constraints = {
        audio: true,
        video: true // Request any video device
      };

      try {
        // Try the fallback constraints
        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        streamAttemptSuccess = true;
      } catch (err2) {
        console.error('Attempt 2 (Any camera/Standard) failed:', err2.message);
        showMessage('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ' + (err2.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 4000);
        return false;
      }
    }
    
    // If we reach here, a stream was successfully obtained (streamAttemptSuccess is true)
    
    preview.srcObject = mediaStream;
    await preview.play();

    const videoTrack = mediaStream.getVideoTracks()[0];
    const settings = videoTrack.getSettings();
    const actualFps = settings.frameRate || 30; // Fallback to 30

    // Update FPS select value based on actual settings, in case 240fps was requested but 
    // only a lower high-speed FPS (like 120) was granted, or if the fallback was used.
    const currentSelectedFps = actualFps > 60 ? 240 : 30;
    fpsSelect.value = currentSelectedFps.toString();
    
    console.log('Camera started - Requested:', selectedFps, 'Actual:', actualFps, 'Facing:', settings.facingMode || 'unknown');
    showMessage(`ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ (${Math.round(actualFps)}fps)`, 1500);
    
    return true;
  }

  // ìš”ì²­í•˜ì‹  'ë…¹í™”ì§„í–‰ ì‚¬í•­ì„ ì‹œê³„ë¡œ ë³¼ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥(Onform appì²˜ëŸ¼)'
  function startTimer() {
    timerT0 = performance.now();
    topTimer.textContent = '00:00.00';
    topTimerWrap.classList.add('active'); // Show timer

    timerInterval = setInterval(() => {
      const elapsed = performance.now() - timerT0;
      const minutes = Math.floor(elapsed / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);
      const centiseconds = Math.floor((elapsed % 1000) / 10); // 1/100ì´ˆ

      const mm = String(minutes).padStart(2, '0');
      const ss = String(seconds).padStart(2, '0');
      const cc = String(centiseconds).padStart(2, '0');
      
      topTimer.textContent = `${mm}:${ss}.${cc}`;
    }, 50); // Update every 50ms for 1/100s precision
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    topTimerWrap.classList.remove('active'); // Hide timer
  }

  // ë…¹í™” ì‹œì‘/ì¤‘ì§€ ë¡œì§ ìˆ˜ì • ë° í†µí•©
  async function startRecording() {
    if (!supportsMediaRecorder) {
      showMessage('ë…¹í™”ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.', 4000);
      return;
    }

    if (!mediaStream || !mediaStream.active) {
      const started = await startPreview();
      if (!started) return;
    }

    recordedChunks = [];
    const mimeType = chooseMimeType();
    
    try {
      const options = mimeType ? { mimeType } : {};
      mediaRecorder = new MediaRecorder(mediaStream, options);
      
      mediaRecorder.ondataavailable = (event) => {
        if (event.data && event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = handleRecordingStop;
      
      mediaRecorder.onerror = (event) => {
        console.error('MediaRecorder error:', event);
        showMessage('ë…¹í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 3000);
        // Call stopRecording to clean up state
        stopRecording();
      };
      
      // ë…¹í™” ì‹œì‘ ì‹œ ì†Œë¦¬ ì¬ìƒ
      playBeep();
      
      // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ë…¹í™” ì‹œì‘
      await new Promise(resolve => setTimeout(resolve, 100));

      mediaRecorder.start(1000); // Collect data every 1000ms (1 second)
      isRecording = true;
      
      recordBtn.classList.add('recording');
      recordBtn.setAttribute('aria-pressed', 'true');
      
      startTimer(); // Start the Onform-like timer
      showMessage('ğŸ”´ ë…¹í™” ì‹œì‘', 1000);
      
    } catch (err) {
      console.error('Failed to start recording:', err);
      showMessage('ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message, 3000);
      isRecording = false;
      recordBtn.classList.remove('recording');
    }
  }

  function stopRecording() {
    if (!isRecording || !mediaRecorder) {
      return;
    }

    try {
      if (mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
      
      isRecording = false;
      recordBtn.classList.remove('recording');
      recordBtn.setAttribute('aria-pressed', 'false');
      stopTimer(); // Stop the Onform-like timer
      
      showMessage('ë…¹í™” ì¤‘ì§€', 1000);
    } catch (err) {
      console.error('Error stopping recording:', err);
    }
  }

  function handleRecordingStop() {
    if (recordedChunks.length === 0) {
      showMessage('ë…¹í™”ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 2000);
      return;
    }

    try {
      // Use the MIME type determined by MediaRecorder
      const mimeType = mediaRecorder.mimeType || 'video/webm'; 
      const blob = new Blob(recordedChunks, { type: mimeType });
      
      if (blob.size < 1000) {
        showMessage('ë…¹í™”ëœ ë°ì´í„°ê°€ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 3000);
        return;
      }
      
      const url = URL.createObjectURL(blob);
      openPlayback(url, blob);

    } catch (err) {
      console.error('Error handling recording stop:', err);
      showMessage('ë…¹í™” íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 3000);
    }
  }

  function openPlayback(url, file) {
    playbackArea.classList.remove('hidden');
    playbackArea.setAttribute('aria-hidden', 'false');
    
    playback.src = url;
    playback.playbackRate = 1.0; 
    
    saveBtn.onclick = () => saveVideo(file);
    
    // ê°¤ëŸ¬ë¦¬/ë…¹í™” ì˜ìƒ ëª¨ë‘ 30fps ê¸°ë³¸ ì¬ìƒ ì†ë„ë¡œ ì‹œì‘
    setPlaybackSpeed(30);

    // iOSì—ì„œ í”Œë ˆì´ë°± ë¹„ë””ì˜¤ê°€ ì˜ ë³´ì´ë„ë¡ ê°•ì œë¡œ play ì‹œë„
    playback.onloadedmetadata = () => {
        playback.play().catch(e => console.warn('Autoplay failed:', e));
    };

    // í•­ìƒ ì¬ìƒ ì†ë„ ë²„íŠ¼ì´ í™œì„±í™”ë˜ë„ë¡ ì œì–´
    speed30.disabled = false;
    speed240.disabled = false;
  }

  // ìš”ì²­í•˜ì‹  'ì‚¬ì§„ì²©ì—ì„œ ë¶ˆëŸ¬ì˜¨ ì˜ìƒì´ 30fpsê³¼ 240fpsìœ¼ë¡œ ì¬ìƒì´ ì˜ë˜ì§€ ì•ŠëŠ”ë‹¤. ì´ ë‘ê°€ì§€ ì†ë„ë¡œë§Œ ì¬ìƒì´ ë˜ê²Œ í•´ì¤˜' ê¸°ëŠ¥
  function setPlaybackSpeed(fps) {
    if (!playback.src) return;
    
    // 30fps = ì •ìƒ ì†ë„ (1.0x)
    // 240fps = ìŠ¬ë¡œìš° ëª¨ì…˜ (1/8 ì†ë„ = 0.125x)
    const rate = fps === 30 ? 1.0 : 0.125;
    playback.playbackRate = rate;
    
    speedOverlay.textContent = fps === 30 ? '30fps (1x)' : '240fps (1/8x)';
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    speed30.classList.toggle('active', fps === 30);
    speed240.classList.toggle('active', fps === 240);
    
    // ì¬ìƒ ë²„íŠ¼ì´ í™œì„±í™”ëœ ìƒíƒœì—ì„œ ì†ë„ ë³€ê²½ ì‹œ ë°”ë¡œ ì¬ìƒë˜ë„ë¡ ì„¤ì •
    if (playback.paused) {
      playback.play().catch(e => console.warn('Play failed after speed change:', e));
    }
    
    console.log('Playback speed set to:', rate, 'for', fps, 'fps');
  }

  async function saveVideo(file) {
    if (!file) {
      showMessage('ì €ì¥í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤', 2000);
      return;
    }

    // íŒŒì¼ ì´ë¦„ ì •ì˜ (í™•ì¥ìëŠ” blob íƒ€ì…ì— ë”°ë¼ ê²°ì •)
    const mimeType = file.type || 'video/webm';
    const extension = mimeType.includes('mp4') ? 'mp4' : (mimeType.includes('webm') ? 'webm' : 'video');
    const fileName = `swing_${Date.now()}.${extension}`;

    // íŒŒì¼ Blobì„ ì–»ìŠµë‹ˆë‹¤. (File ê°ì²´ë¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©, Blob URLì´ë¼ë©´ fetchë¡œ Blobìœ¼ë¡œ ë³€í™˜)
    let blobToSave = file instanceof Blob ? file : await (await fetch(file.src)).blob();
    
    try {
      // 1. Web Share API ì‹œë„ (iOSì—ì„œ ê°€ì¥ ì¢‹ì€ ì €ì¥ ê²½í—˜ ì œê³µ)
      if (navigator.share && navigator.canShare) {
        const fileToShare = new File([blobToSave], fileName, { type: blobToSave.type });
        
        if (navigator.canShare({ files: [fileToShare] })) {
          await navigator.share({
            files: [fileToShare],
            title: 'ê³¨í”„ ìŠ¤ìœ™ ì˜ìƒ'
          });
          showMessage('ê³µìœ  ì™„ë£Œ. ê³µìœ  ì‹œíŠ¸ì—ì„œ "ë¹„ë””ì˜¤ ì €ì¥"ì„ ì„ íƒí•˜ì„¸ìš”.', 3500);
          return;
        }
      }
    } catch (err) {
      console.log('Share API failed or cancelled (ì •ìƒì ì¸ ì·¨ì†Œ):', err);
    }

    // 2. Fallback: ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
    const url = URL.createObjectURL(blobToSave);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showMessage('ë‹¤ìš´ë¡œë“œ ì‹œì‘. íŒŒì¼ì„ ê¸¸ê²Œ ëˆŒëŸ¬ ì‚¬ì§„ ì•±ì— ì €ì¥í•˜ì„¸ìš”.', 4000);
  }

  // --- Event Listeners ---
  recordBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    // ë…¹í™” ì¤‘ì¼ ë•Œ: ì¤‘ì§€, ë…¹í™” ì¤‘ì´ ì•„ë‹ ë•Œ: ì‹œì‘
    if (isRecording) {
      stopRecording();
    } else {
      await startRecording();
    }
  });

  closePlayback.addEventListener('click', () => {
    playback.pause();
    playback.src = '';
    playback.removeAttribute('src'); // Clean up src
    playbackArea.classList.add('hidden');
    playbackArea.setAttribute('aria-hidden', 'true');
    // ì¬ìƒ ì†ë„ ë²„íŠ¼ ì´ˆê¸°í™”
    speed30.classList.add('active');
    speed240.classList.remove('active');
  });

  speed30.addEventListener('click', () => setPlaybackSpeed(30));
  speed240.addEventListener('click', () => setPlaybackSpeed(240));

  galleryBtn.addEventListener('click', () => {
    fileInput.click();
  });

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file || !file.type.startsWith('video/')) {
      showMessage('ìœ íš¨í•œ ë¹„ë””ì˜¤ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.', 1200);
      fileInput.value = ''; // Reset file input
      return;
    }

    const url = URL.createObjectURL(file);
    openPlayback(url, file); // Blob/File ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬

    showMessage('ê°¤ëŸ¬ë¦¬ì—ì„œ ë¶ˆëŸ¬ì˜´', 1200);
    
    // Reset file input
    fileInput.value = '';
  });

  // FPS ì„ íƒì´ ë³€ê²½ë  ë•Œ: ë¯¸ë¦¬ë³´ê¸° ë‹¤ì‹œ ì‹œì‘
  fpsSelect.addEventListener('change', async () => {
    if (isRecording) {
      showMessage('ë…¹í™” ì¤‘ì—ëŠ” FPSë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 2000);
      return;
    }
    
    recordBtn.disabled = true; // ì ì‹œ ë…¹í™” ë²„íŠ¼ ë¹„í™œì„±í™”
    await startPreview();
    recordBtn.disabled = false; // ë‹¤ì‹œ í™œì„±í™”
  });
  
  // 240fps ì§€ì› ì—¬ë¶€ í™•ì¸ ë¡œì§
  async function check240fpsSupport() {
    const option240 = fpsSelect.querySelector('option[value="240"]');
    if (!option240) return false;

    // ê¸°ë³¸ì ìœ¼ë¡œ 240fps ì˜µì…˜ì„ ë¹„í™œì„±í™”í•˜ê³  ì§€ì› ì—¬ë¶€ì— ë”°ë¼ í™œì„±í™”í•©ë‹ˆë‹¤.
    option240.disabled = true;
    option240.textContent = '240fps (í™•ì¸ ì¤‘)';
    
    try {
      // 240fpsë¥¼ ì‹œë„í•˜ì—¬ ìµœëŒ€ ì§€ì› í”„ë ˆì„ë¥  í™•ì¸
      const testStream = await navigator.mediaDevices.getUserMedia({
        video: { 
          // 240fpsë¥¼ ìš”ì²­í•˜ì—¬ ì‹¤ì œ ì¹´ë©”ë¼ê°€ ì–¼ë§ˆë‚˜ ë†’ì€ FPSë¥¼ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸
          frameRate: { ideal: 240, max: 240 } 
        }
      });
      
      const videoTrack = testStream.getVideoTracks()[0];
      const settings = videoTrack.getSettings();
      
      testStream.getTracks().forEach(t => t.stop());
      
      const actualFps = settings.frameRate || 0;
      
      // ì‹¤ì œ ì§€ì› FPSê°€ ê³ ì† í”„ë ˆì„ (ì˜ˆ: 120fps ì´ìƒ)ì¸ì§€ í™•ì¸
      if (actualFps >= 120) {
        is240fpsSupported = true;
        option240.disabled = false;
        option240.textContent = '240fps (ìŠ¬ë¡œìš° ëª¨ì…˜)';
        console.log(`240fps (ì‹¤ì œ ì§€ì›: ${actualFps}fps) ì§€ì› í™•ì¸`);
        return true;
      } else {
        option240.textContent = `240fps (ë¯¸ì§€ì›: Max ${Math.round(actualFps)}fps)`;
        console.log(`240fps ë¯¸ì§€ì›. ìµœëŒ€ FPS: ${Math.round(actualFps)}`);
        return false;
      }
    } catch (err) {
      console.warn('240fps check failed, falling back to 30fps:', err.message);
      option240.textContent = '240fps (ë¯¸ì§€ì›)';
      return false;
    }
  }

  // Initialize
  (async function init() {
    console.log('Initializing Golf Swing Recorder...');
    
    if (!supportsGetUserMedia || !supportsMediaRecorder) {
      showMessage('ì¹´ë©”ë¼ ë˜ëŠ” ë…¹í™” ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 6000);
      recordBtn.disabled = true;
      return;
    }

    // 240fps ì§€ì› ì—¬ë¶€ë¥¼ ë¨¼ì € í™•ì¸
    await check240fpsSupport();

    // ê¸°ë³¸ ì„¤ì •(30fps)ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° ì‹œì‘
    await startPreview();
    
    console.log('Initialization complete');
  })();
});
</script>
</body>
</html>
